build_php7() {
    docker build -t php7-dev - << 'EOF'
FROM php:7.4-cli
RUN apt-get update && \
    apt-get install -y zip unzip libzip-dev libpng-dev libjpeg-dev libfreetype6-dev && \
    docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install zip gd exif pdo_mysql mysqli && \
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
EOF
}

php7() {
    if ! docker image inspect php7-dev &> /dev/null; then
        echo "Building php7-dev image..."
        build_php7
    fi
    
    docker run -it --rm \
        -v "$(pwd):/workspace" \
        -w /workspace \
        -p 8000:8000 \
        --link mariadb-dev:mysql \
        php7-dev \
        bash
}

mariadb_start() {
    docker run -d \
        --name mariadb-dev \
        -e MYSQL_ROOT_PASSWORD=root \
        -e MYSQL_DATABASE=mydb \
        -p 3306:3306 \
        -v mariadb_data:/var/lib/mysql \
        -v "$(pwd):/dumps" \
        --tmpfs /tmp:rw,noexec,nosuid,size=2g \
        mariadb:10.11 \
        --innodb-buffer-pool-size=1G \
        --max-allowed-packet=1G \
        --innodb-log-file-size=512M \
        --innodb-flush-log-at-trx-commit=2
}

mariadb_phpmyadmin_start() {
    docker run -d \
        --name phpmyadmin-dev \
        --link mariadb-dev:db \
        -e PMA_HOST=mariadb-dev \
        -e PMA_USER=root \
        -e PMA_PASSWORD=root \
        -p 8080:80 \
        phpmyadmin/phpmyadmin:latest
    
    echo "phpMyAdmin available at: http://localhost:8080"
    echo "Username: root"
    echo "Password: root"
}

mariadb_phpmyadmin_stop() {
    docker stop phpmyadmin-dev
    docker rm phpmyadmin-dev
}

mariadb_stack_start() {
    mariadb_start
    sleep 5
    mariadb_phpmyadmin_start
}

mariadb_stack_stop() {
    mariadb_phpmyadmin_stop 2>/dev/null
    mariadb_stop
}

mariadb_import() {
    if [ -z "$1" ]; then
        echo "Usage: mariadb_import <dump_file.sql>"
        return 1
    fi
    
    echo "Importing $1..."
    docker exec -i mariadb-dev mysql -uroot -proot mydb < "$1"
}

mariadb_shell() {
    docker exec -it mariadb-dev mysql -uroot -proot mydb
}

mariadb_stop() {
    docker stop mariadb-dev
    docker rm mariadb-dev
}

mariadb_logs() {
    docker logs -f mariadb-dev
}

mariadb_recreate_db() {
    if [ -z "$1" ]; then
        echo "Usage: mariadb_recreate_db <database_name>"
        return 1
    fi
    local db_name="$1"
    
    echo "Dropping database '$db_name' if it exists..."
    docker exec mariadb-dev mysql -uroot -proot -e "DROP DATABASE IF EXISTS \`$db_name\`;"
    
    echo "Creating new database '$db_name'..."
    docker exec mariadb-dev mysql -uroot -proot -e "CREATE DATABASE \`$db_name\`;"
    echo "Database '$db_name' recreated successfully."
}

bfm() {
    if ! command -v idf.py &> /dev/null; then
        echo "ESP-IDF not detected. Loading environment..."
        source "$HOME/esp/esp-idf/export.sh" > /dev/null 2>&1
    fi

    local port=${1:-1}
    idf.py -p "/dev/ttyACM$port" -b 115200 build flash monitor
}

idf() {
    if ! command -v idf.py &> /dev/null; then
        source "$HOME/esp/esp-idf/export.sh" > /dev/null 2>&1
    fi

    idf.py "$@"
}
